{% extends "layouts/base.html" %}

{% block title %}Dashboard - Guardería{% endblock %}

{% block header_title %}Dashboard{% endblock %}

{% block content %}
      <div class="flex items-center justify-between mb-8">
        <a href="{{ url_for('dashboard', date=prev_week_start_str) }}" class="bg-pink-500 hover:bg-pink-600 text-white p-3 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-300">
            <i class="fas fa-chevron-left text-xl"></i>
        </a>
        <div class="text-center">
            <h1 class="text-4xl font-extrabold text-pink-700 tracking-tight drop-shadow-sm">
                Resumen Semanal
            </h1>
            <p class="text-lg text-pink-500 mt-2">{{ week_start_str }} - {{ week_end_str }}</p>
        </div>
        <a href="{{ url_for('dashboard', date=next_week_start_str) }}" class="bg-pink-500 hover:bg-pink-600 text-white p-3 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-300">
            <i class="fas fa-chevron-right text-xl"></i>
        </a>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Tarjeta: Reporte de Hoy -->
        <a href="{{ url_for('hoy') }}" class="block">
          <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-pink-100 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl cursor-pointer">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-pink-600">Reporte de Hoy</h3>
              <i class="fas fa-calendar-day text-pink-400 text-3xl"></i>
            </div>
            <p class="text-4xl font-bold text-pink-800">${{ today_ninos_total }}</p>
            <p class="text-pink-500 text-sm mt-2">Pago por hora: ${{ today_payment_per_hour }}</p>
          </div>
        </a>

        <!-- Tarjeta: Cantidad de niños en la semana -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-pink-100 transform transition-all duration-300 hover:scale-[1.02]">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-pink-600">Niños en la Semana</h3>
            <i class="fas fa-baby text-pink-400 text-3xl"></i>
          </div>
          <p class="text-4xl font-bold text-pink-800">{{ week_ninos_unique_count }}</p>
          <p class="text-pink-500 text-sm mt-2">Niños únicos que han asistido esta semana</p>
        </div>

        <!-- Tarjeta: Monto - Gasto -->
        <a href="{{ url_for('gastos') }}" class="block">
          <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-pink-100 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl cursor-pointer">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-pink-600">Monto - Gasto</h3>
              <i class="fas fa-balance-scale text-pink-400 text-3xl"></i>
            </div>
            <div class="space-y-2">
              <div class="flex items-center space-x-2 mb-2">
                <p class="text-xl font-bold text-green-600">${{ "%.2f"|format(week_ninos_total) }}</p>
                <p class="text-xl font-bold text-red-600">- ${{ "%.2f"|format(week_gastos_total) }}</p>
              </div>
              <div class="pt-2 border-t border-pink-100">
                <p class="text-3xl font-bold text-pink-800">${{ "%.2f"|format(week_ninos_total - week_gastos_total) }}</p>
              </div>
            </div>
          </div>
        </a>

        <!-- Tarjeta: Cantidad de trabajadoras activas -->
        <a href="{{ url_for('employees') }}" class="block">
          <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-pink-100 transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl cursor-pointer">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-pink-600">Trabajadoras Activas</h3>
              <i class="fas fa-user-tie text-pink-400 text-3xl"></i>
            </div>
            <p class="text-4xl font-bold text-pink-800">{{ active_employees_count }}</p>
            <p class="text-pink-500 text-sm mt-2">Empleadas actualmente en servicio</p>
          </div>
        </a>
      </div>

      <!-- Gráfico semanal y tarjeta de trabajadoras -->
      <div class="mt-8 grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Gráfico semanal (ocupa 3 columnas) -->
        <div class="lg:col-span-3 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-pink-100">
          <h3 class="text-2xl font-semibold text-pink-700 mb-4">Resumen Semanal de Montos</h3>
          <div class="h-64">
            <canvas id="weeklyChart"></canvas>
          </div>
        </div>

        <!-- Tarjeta de trabajadoras (ocupa 1 columna) -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-pink-100">
          <h3 class="text-xl font-semibold text-pink-700 mb-4">
            <i class="fas fa-user-tie mr-2"></i>
            Trabajadoras de la Semana
          </h3>
          {% if week_employees_earnings %}
            <div class="space-y-3 max-h-64 overflow-y-auto">
              {% for employee in week_employees_earnings %}
              <div class="bg-pink-50 rounded-lg p-3 border border-pink-200">
                <div class="flex justify-between items-start mb-2">
                  <h4 class="font-semibold text-pink-800 text-sm">{{ employee.nombre }}</h4>
                  <span class="text-xs text-pink-600 bg-pink-100 px-2 py-1 rounded">{{ employee.dias_trabajados }} días</span>
                </div>
                <div class="text-xs text-pink-600">
                  <div>Horas: {{ "%.1f"|format(employee.total_horas) }}</div>
                  <div class="font-semibold text-pink-700">Ganancia: ${{ "%.2f"|format(employee.total_ganancia) }}</div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-8">
              <i class="fas fa-user-tie text-pink-300 text-3xl mb-3"></i>
              <p class="text-pink-500 text-sm">No hay trabajadoras registradas esta semana</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Botón flotante para agregar asistencia -->
      <button id="addAttendanceBtn" class="fixed bottom-6 right-6 w-16 h-16 bg-pink-500 hover:bg-pink-600 text-white rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-300 z-50 flex items-center justify-center">
        <i class="fas fa-plus text-2xl"></i>
      </button>

      <!-- Modal principal para agregar asistencia -->
      <div id="attendanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300">
          <div class="text-center">
            <h2 class="text-2xl font-bold text-pink-700 mb-6">Agregar Asistencia</h2>
            
            <div class="space-y-4">
              <button onclick="showNinoModal()" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                <i class="fas fa-baby mr-3"></i>
                Niño
              </button>
              
              <button onclick="showEmployeeModal()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                <i class="fas fa-user-tie mr-3"></i>
                Empleada
              </button>
            </div>
            
            <button id="closeModalBtn" class="mt-6 text-gray-500 hover:text-gray-700 font-medium transition-colors duration-300">
              Cancelar
            </button>
          </div>
        </div>
      </div>

      <!-- Modal para seleccionar niño -->
      <div id="ninoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full mx-4 max-w-sm transform transition-all duration-300">
          <div class="text-center">
            <h2 class="text-xl font-bold text-pink-700 mb-4">Seleccionar Niño</h2>
            
            <div id="ninosList" class="max-h-80 overflow-y-auto mb-4">
              <!-- Lista de niños se cargará aquí -->
            </div>
            
            <button onclick="closeNinoModal()" class="text-gray-500 hover:text-gray-700 font-medium transition-colors duration-300">
              Cancelar
            </button>
          </div>
        </div>
      </div>

      <!-- Modal para seleccionar empleada -->
      <div id="employeeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full mx-4 max-w-sm transform transition-all duration-300">
          <div class="text-center">
            <h2 class="text-xl font-bold text-blue-700 mb-4">Seleccionar Empleada</h2>
            
            <div id="employeesList" class="max-h-80 overflow-y-auto mb-4">
              <!-- Lista de empleados se cargará aquí -->
            </div>
            
            <button onclick="closeEmployeeModal()" class="text-gray-500 hover:text-gray-700 font-medium transition-colors duration-300">
              Cancelar
            </button>
          </div>
        </div>
      </div>

      <!-- Modal para confirmar asistencia de niño -->
      <div id="confirmNinoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300">
          <div class="text-center">
            <h2 class="text-2xl font-bold text-pink-700 mb-6">Confirmar Asistencia</h2>
            
            <div class="space-y-4 text-left">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Niño:</label>
                <p id="selectedNinoName" class="text-lg font-semibold text-pink-600"></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
                <input type="date" id="ninoFecha" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Monto:</label>
                <input type="number" id="ninoMonto" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
              </div>
            </div>
            
            <div class="flex space-x-4 mt-6">
              <button onclick="saveNinoAsistencia()" class="flex-1 bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300">
                Guardar
              </button>
              <button onclick="closeConfirmNinoModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-300">
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal para confirmar asistencia de empleada -->
      <div id="confirmEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300">
          <div class="text-center">
            <h2 class="text-2xl font-bold text-blue-700 mb-6">Confirmar Asistencia</h2>
            
            <div class="space-y-4 text-left">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Empleada:</label>
                <p id="selectedEmployeeName" class="text-lg font-semibold text-blue-600"></p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
                <input type="date" id="employeeFecha" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Horas:</label>
                <input type="number" id="employeeHoras" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            
            <div class="flex space-x-4 mt-6">
              <button onclick="saveEmployeeAsistencia()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300">
                Guardar
              </button>
              <button onclick="closeConfirmEmployeeModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-300">
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>

{% endblock %}

{% block extra_js %}
<script>
  // Variables globales
  let selectedNino = null;
  let selectedEmployee = null;

  // Funcionalidad del modal principal
  const addAttendanceBtn = document.getElementById('addAttendanceBtn');
  const attendanceModal = document.getElementById('attendanceModal');
  const closeModalBtn = document.getElementById('closeModalBtn');

  // Abrir modal principal
  addAttendanceBtn.addEventListener('click', () => {
    attendanceModal.classList.remove('hidden');
    attendanceModal.classList.add('flex');
  });

  // Cerrar modal principal
  closeModalBtn.addEventListener('click', () => {
    attendanceModal.classList.add('hidden');
    attendanceModal.classList.remove('flex');
  });

  // Cerrar modal haciendo clic fuera
  attendanceModal.addEventListener('click', (e) => {
    if (e.target === attendanceModal) {
      attendanceModal.classList.add('hidden');
      attendanceModal.classList.remove('flex');
    }
  });

  // Cerrar modal con ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeAllModals();
    }
  });

  // Función para cerrar todos los modales
  function closeAllModals() {
    document.querySelectorAll('[id$="Modal"]').forEach(modal => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });
  }

  // Mostrar modal de niños
  function showNinoModal() {
    attendanceModal.classList.add('hidden');
    attendanceModal.classList.remove('flex');
    
    const ninosModal = document.getElementById('ninoModal');
    ninosModal.classList.remove('hidden');
    ninosModal.classList.add('flex');
    
    loadNinos();
  }

  // Cerrar modal de niños
  function closeNinoModal() {
    const ninosModal = document.getElementById('ninoModal');
    ninosModal.classList.add('hidden');
    ninosModal.classList.remove('flex');
    
    attendanceModal.classList.remove('hidden');
    attendanceModal.classList.add('flex');
  }

  // Mostrar modal de empleados
  function showEmployeeModal() {
    attendanceModal.classList.add('hidden');
    attendanceModal.classList.remove('flex');
    
    const employeeModal = document.getElementById('employeeModal');
    employeeModal.classList.remove('hidden');
    employeeModal.classList.add('flex');
    
    loadEmployees();
  }

  // Cerrar modal de empleados
  function closeEmployeeModal() {
    const employeeModal = document.getElementById('employeeModal');
    employeeModal.classList.add('hidden');
    employeeModal.classList.remove('flex');
    
    attendanceModal.classList.remove('hidden');
    attendanceModal.classList.add('flex');
  }

  // Cargar lista de niños
  async function loadNinos() {
    try {
      const response = await fetch('/api/ninos-activos');
      const ninos = await response.json();
      
      const ninosList = document.getElementById('ninosList');
      ninosList.innerHTML = '';
      
      // Crear contenedor con grid de 2 columnas
      const gridContainer = document.createElement('div');
      gridContainer.className = 'grid grid-cols-2 gap-3';
      
      ninos.forEach(nino => {
        const ninoCard = document.createElement('div');
        ninoCard.className = 'bg-pink-50 hover:bg-pink-100 p-4 rounded-lg cursor-pointer transition-all duration-300 border border-pink-200 text-center';
        ninoCard.innerHTML = `
          <div class="flex flex-col items-center">
            <i class="fas fa-baby text-pink-400 text-2xl mb-2"></i>
            <h3 class="font-semibold text-pink-700 text-sm">${nino.nombre}</h3>
          </div>
        `;
        
        ninoCard.addEventListener('click', () => selectNino(nino));
        gridContainer.appendChild(ninoCard);
      });
      
      ninosList.appendChild(gridContainer);
    } catch (error) {
      console.error('Error cargando niños:', error);
    }
  }

  // Cargar lista de empleados
  async function loadEmployees() {
    try {
      const response = await fetch('/api/employees-activos');
      const employees = await response.json();
      
      const employeesList = document.getElementById('employeesList');
      employeesList.innerHTML = '';
      
      // Crear contenedor con grid de 2 columnas
      const gridContainer = document.createElement('div');
      gridContainer.className = 'grid grid-cols-2 gap-3';
      
      employees.forEach(employee => {
        const employeeCard = document.createElement('div');
        employeeCard.className = 'bg-blue-50 hover:bg-blue-100 p-4 rounded-lg cursor-pointer transition-all duration-300 border border-blue-200 text-center';
        employeeCard.innerHTML = `
          <div class="flex flex-col items-center">
            <i class="fas fa-user-tie text-blue-400 text-2xl mb-2"></i>
            <h3 class="font-semibold text-blue-700 text-sm">${employee.nombre}</h3>
          </div>
        `;
        
        employeeCard.addEventListener('click', () => selectEmployee(employee));
        gridContainer.appendChild(employeeCard);
      });
      
      employeesList.appendChild(gridContainer);
    } catch (error) {
      console.error('Error cargando empleados:', error);
    }
  }

  // Seleccionar niño
  function selectNino(nino) {
    selectedNino = nino;
    
    // Cerrar modal de niños
    closeNinoModal();
    
    // Mostrar modal de confirmación
    const confirmModal = document.getElementById('confirmNinoModal');
    confirmModal.classList.remove('hidden');
    confirmModal.classList.add('flex');
    
    // Llenar datos
    document.getElementById('selectedNinoName').textContent = nino.nombre;
    document.getElementById('ninoFecha').value = new Date().toISOString().split('T')[0];
    document.getElementById('ninoMonto').value = nino.monto;
  }

  // Seleccionar empleada
  function selectEmployee(employee) {
    selectedEmployee = employee;
    
    // Cerrar modal de empleados
    closeEmployeeModal();
    
    // Mostrar modal de confirmación
    const confirmModal = document.getElementById('confirmEmployeeModal');
    confirmModal.classList.remove('hidden');
    confirmModal.classList.add('flex');
    
    // Llenar datos
    document.getElementById('selectedEmployeeName').textContent = employee.nombre;
    document.getElementById('employeeFecha').value = new Date().toISOString().split('T')[0];
    document.getElementById('employeeHoras').value = employee.horas;
  }

  // Cerrar modal de confirmación de niño
  function closeConfirmNinoModal() {
    const confirmModal = document.getElementById('confirmNinoModal');
    confirmModal.classList.add('hidden');
    confirmModal.classList.remove('flex');
    
    attendanceModal.classList.remove('hidden');
    attendanceModal.classList.add('flex');
  }

  // Cerrar modal de confirmación de empleada
  function closeConfirmEmployeeModal() {
    const confirmModal = document.getElementById('confirmEmployeeModal');
    confirmModal.classList.add('hidden');
    confirmModal.classList.remove('flex');
    
    attendanceModal.classList.remove('hidden');
    attendanceModal.classList.add('flex');
  }

  // Guardar asistencia de niño
  async function saveNinoAsistencia() {
    if (!selectedNino) return;
    
    const fecha = document.getElementById('ninoFecha').value;
    const monto = document.getElementById('ninoMonto').value;
    
    if (!fecha || !monto) {
      alert('Por favor complete todos los campos');
      return;
    }
    
    try {
      const response = await fetch('/api/asistencia', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          fecha: fecha,
          tipo: 'nino',
          id_persona: selectedNino.id,
          valor: parseFloat(monto)
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert('Asistencia guardada exitosamente');
        closeConfirmNinoModal();
        selectedNino = null;
        // Recargar la página para mostrar los nuevos datos
        window.location.reload();
      } else {
        alert('Error al guardar la asistencia: ' + result.error);
      }
    } catch (error) {
      console.error('Error guardando asistencia:', error);
      alert('Error al guardar la asistencia');
    }
  }

  // Guardar asistencia de empleada
  async function saveEmployeeAsistencia() {
    if (!selectedEmployee) return;
    
    const fecha = document.getElementById('employeeFecha').value;
    const horas = document.getElementById('employeeHoras').value;
    
    if (!fecha || !horas) {
      alert('Por favor complete todos los campos');
      return;
    }
    
    try {
      const response = await fetch('/api/asistencia', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          fecha: fecha,
          tipo: 'trabajadora',
          id_persona: selectedEmployee.id,
          valor: parseFloat(horas)
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert('Asistencia guardada exitosamente');
        closeConfirmEmployeeModal();
        selectedEmployee = null;
        // Recargar la página para mostrar los nuevos datos
        window.location.reload();
      } else {
        alert('Error al guardar la asistencia: ' + result.error);
      }
    } catch (error) {
      console.error('Error guardando asistencia:', error);
      alert('Error al guardar la asistencia');
    }
  }

  // Gráfico semanal
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('weeklyChart');
    if (ctx) {
      const weeklyData = {{ week_daily_amounts|tojson }};
      
      const labels = weeklyData.map(item => item.day);
      const data = weeklyData.map(item => item.amount);
      const dates = weeklyData.map(item => item.date);
      
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Monto Diario ($)',
            data: data,
            borderColor: '#ec4899',
            backgroundColor: 'rgba(236, 72, 153, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#ec4899',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(236, 72, 153, 0.9)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#ec4899',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return `$${context.parsed.y.toFixed(2)}`;
                },
                afterLabel: function(context) {
                  return 'Haz clic para ver detalles';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(236, 72, 153, 0.1)',
                drawBorder: false
              },
              ticks: {
                color: '#ec4899',
                font: {
                  weight: '600'
                },
                callback: function(value) {
                  return '$' + value.toFixed(0);
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#ec4899',
                font: {
                  weight: '600'
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          onClick: function(event, elements) {
            if (elements.length > 0) {
              const index = elements[0].index;
              const date = dates[index];
              if (date) {
                window.location.href = `/hoy/${date}`;
              }
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}
