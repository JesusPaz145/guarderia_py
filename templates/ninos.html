{% extends "layouts/base.html" %}

{% block title %}Niños - Guardería{% endblock %}

{% block header_title %}Registro de Niños{% endblock %}

{% block extra_css %}
<style>
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}
.modal.active {
    display: flex;
    justify-content: center;
    align-items: center;
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Encabezado con botón de agregar -->
  <div class="flex justify-between items-center">
    <h1 class="text-4xl font-extrabold text-pink-700 tracking-tight drop-shadow-sm">
      Registro de Niños
    </h1>
    <button class="bg-pink-400 hover:bg-pink-500 text-white px-6 py-2 rounded-xl shadow-lg transition-all duration-200 flex items-center space-x-2">
      <i class="fas fa-plus"></i>
      <span>Agregar Niño</span>
    </button>
  </div>

  <!-- Tabla de Niños -->
  <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-pink-100">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-pink-50">
          <tr>
            <th class="px-6 py-4 text-left text-pink-600">Nombre</th>
            <th class="px-6 py-4 text-left text-pink-600">Monto</th>
            <th class="px-6 py-4 text-left text-pink-600">Representante</th>
            <th class="px-6 py-4 text-center text-pink-600">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-pink-100">
          {% if not ninos %}
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-gray-500">No hay registros para mostrar</td>
          </tr>
          {% endif %}
          {% for nino in ninos %}
          <tr class="hover:bg-pink-50/50 transition-colors" data-id="{{ nino.id }}">
            <td class="px-6 py-4">{{ nino.nombre }}</td>
            <td class="px-6 py-4">${{ nino.monto }}</td>
            <td class="px-6 py-4">{{ nino.representante }}</td>
            <td class="px-6 py-4 text-center space-x-2">
              <button class="text-blue-500 hover:text-blue-700" onclick="editarNino({{ nino.id }})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="text-red-500 hover:text-red-700" onclick="eliminarNino({{ nino.id }})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para añadir/editar niños -->
<div id="modal" class="modal">
    <div class="bg-white p-6 rounded-2xl shadow-xl w-96 relative">
        <h3 class="text-2xl font-bold text-pink-600 mb-4">
            <span id="modalTitle">Agregar Niño</span>
        </h3>
        <form id="ninoForm" class="space-y-4">
            <input type="hidden" id="ninoId">
            <div>
                <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                <input type="text" id="nombre" name="nombre" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
            </div>
            <div>
                <label for="monto" class="block text-sm font-medium text-gray-700">Monto</label>
                <input type="number" id="monto" name="monto" required step="0.01" min="0"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
            </div>
            <div>
                <label for="representante" class="block text-sm font-medium text-gray-700">Representante</label>
                <input type="text" id="representante" name="representante" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="cerrarModal()"
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors">
                    Cancelar
                </button>
                <button type="submit"
                    class="px-4 py-2 bg-pink-500 text-white rounded-xl hover:bg-pink-600 transition-colors">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('modal');
    const form = document.getElementById('ninoForm');
    const addButton = document.querySelector('button.bg-pink-400');

    // Botón de agregar
    addButton.addEventListener('click', function() {
        document.getElementById('modalTitle').textContent = 'Agregar Niño';
        document.getElementById('ninoId').value = '';
        form.reset();
        modal.classList.add('active');
    });

    // Cerrar modal al hacer click fuera
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            cerrarModal();
        }
    });

    // Manejar el formulario
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = document.getElementById('ninoId').value;
        const data = {
            nombre: document.getElementById('nombre').value,
            monto: parseFloat(document.getElementById('monto').value),
            representante: document.getElementById('representante').value
        };

        try {
            const response = await fetch(id ? `/api/ninos/${id}` : '/api/ninos', {
                method: id ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Error del servidor:', errorData);
                throw new Error(errorData.message || 'Error en la respuesta del servidor');
            }

            window.location.reload();
        } catch (error) {
            console.error('Error completo:', error);
            alert(error.message || 'Error al guardar los datos');
        }
    });
});

window.editarNino = function(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    const modal = document.getElementById('modal');
    
    document.getElementById('modalTitle').textContent = 'Editar Niño';
    document.getElementById('ninoId').value = id;
    document.getElementById('nombre').value = row.children[0].textContent;
    document.getElementById('monto').value = row.children[1].textContent.replace('$', '');
    document.getElementById('representante').value = row.children[2].textContent;
    
    modal.classList.add('active');
};

window.eliminarNino = async function(id) {
    if (!confirm('¿Estás seguro de que deseas eliminar este registro?')) {
        return;
    }

    try {
        const response = await fetch(`/api/ninos/${id}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }

        window.location.reload();
    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el registro');
    }
};

window.cerrarModal = function() {
    document.getElementById('modal').classList.remove('active');
};
</script>
{% endblock %}
