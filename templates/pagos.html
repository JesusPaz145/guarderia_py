{% extends "layouts/base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-full">
    <!-- Header simple -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Control de Pagos</h1>
        <button onclick="abrirModalAjuste()" class="text-gray-500 hover:text-gray-800 text-sm font-semibold">
            <i class="fas fa-cog"></i> Ajustes
        </button>
    </div>

    <!-- Layout 60/40 -->
    <div class="flex flex-col lg:flex-row gap-6">

        <!-- IZQUIERDA (60%): PAGOS PENDIENTES (CARDS) -->
        <div class="lg:w-3/5 space-y-4">
            <div
                class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-4 rounded-3xl shadow-sm border border-gray-100">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="filtroNino" onkeyup="filtrarNinos()" placeholder="Buscar niÃ±o para cobrar..."
                        class="pl-10 pr-4 py-2 w-full border border-gray-100 rounded-2xl focus:ring-2 focus:ring-pink-500 focus:outline-none bg-gray-50">
                </div>
                <button onclick="seleccionarTodosToggle()" id="btnSeleccionarTodos"
                    class="text-sm font-bold text-pink-600 hover:text-pink-700 whitespace-nowrap px-4">
                    Seleccionar Todos
                </button>
            </div>

            <div id="ninosGrid" class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-4 pb-24 lg:pb-0">
                {% if not pending_payments %}
                <div class="col-span-full py-20 text-center">
                    <div class="text-gray-300 text-5xl mb-4"><i class="fas fa-check-circle"></i></div>
                    <p class="text-gray-400 font-medium">No hay pagos pendientes. Â¡Todo al dÃ­a!</p>
                </div>
                {% endif %}

                {% for item in pending_payments %}
                <div onclick="toggleNinoSelection(this, '{{ item.id_nino }}', '{{ item.nombre }}', {{ item.saldo_pendiente }})"
                    data-nombre="{{ item.nombre }}"
                    class="nino-card border-2 border-transparent rounded-3xl p-5 cursor-pointer hover:shadow-md transition-all text-center relative bg-white shadow-sm ring-1 ring-gray-100">
                    <div
                        class="w-14 h-14 bg-pink-50 text-pink-500 rounded-full flex items-center justify-center mx-auto mb-3 font-black text-xl shadow-inner">
                        {{ item.nombre[0]|upper }}
                    </div>
                    <h4 class="font-bold text-gray-800 text-sm truncate">{{ item.nombre }}</h4>
                    <p class="text-pink-600 font-black text-sm mt-1">${{ "%.2f"|format(item.saldo_pendiente) }}</p>

                    <!-- Indicador de selecciÃ³n -->
                    <div
                        class="check-mark absolute top-3 right-3 opacity-0 transform scale-50 transition-all text-pink-600">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- DERECHA (40%): HISTORIAL AGRUPADO -->
        <div class="lg:w-2/5">
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden sticky top-6">
                <div class="px-6 py-4 bg-gray-50/50 border-b border-gray-100">
                    <h2 class="text-sm font-black text-gray-400 uppercase tracking-widest">Ãšltimos Pagos</h2>
                </div>
                <div class="max-h-[calc(100vh-200px)] overflow-y-auto">
                    <table class="min-w-full">
                        <tbody class="divide-y divide-gray-50">
                            {% for group in recent_pagos %}
                            <tr onclick="verDetallesGrupo('{{ group.fecha }}', '{{ group.id_empleada }}', '{{ group.nombre_empleada }}', '{{ group.total }}')"
                                class="hover:bg-pink-50/50 cursor-pointer transition-colors group relative">
                                <td class="px-6 py-4">
                                    <div class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">{{
                                        group.fecha }}</div>
                                    <div class="text-xs font-bold text-gray-700 flex flex-col">
                                        <span>{{ group.nombre_empleada }} â€¢ <span class="text-pink-400">{{ group.tipo
                                                }}</span></span>
                                        <span class="text-[10px] text-gray-400 font-medium truncate max-w-[180px]">{{
                                            group.ninos_resumen }}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex items-center justify-end gap-3">
                                        <div class="flex flex-col items-end">
                                            <div class="text-sm font-black text-pink-600">${{ "%.2f"|format(group.total)
                                                }}</div>
                                            <div class="text-[9px] text-gray-400">{{ group.cantidad_pagos }} pagos</div>
                                        </div>

                                        {# BotÃ³n de REVERTIR GRUPO (Solo hoy/futuro) #}
                                        {% set hoy = get_current_time().strftime('%Y-%m-%d') %}
                                        {% if group.fecha >= hoy %}
                                        <button
                                            onclick="event.stopPropagation(); revertirGrupo({{ group.pago_ids|tojson }})"
                                            class="p-2 text-gray-300 hover:text-red-500 transition-colors"
                                            title="Revertir grupo completo">
                                            <i class="fas fa-undo-alt text-xs"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BOTÃ“N FLOTANTE (Solo cuando hay selecciÃ³n) -->
<div id="floatingBtnContainer" class="fixed bottom-8 inset-x-0 flex justify-center z-40 hidden">
    <button onclick="abrirModalConfirmacion()"
        class="bg-pink-600 hover:bg-pink-700 text-white font-black py-4 px-10 rounded-full shadow-2xl transition-all transform hover:scale-105 active:scale-95 flex items-center gap-4 animate-bounce-subtle">
        <span class="bg-white/20 px-3 py-1 rounded-full text-sm" id="countBadge">0</span>
        <span>REGISTRAR PAGO</span>
        <span id="totalBadge" class="bg-pink-800/40 px-4 py-1 rounded-full text-lg">$0.00</span>
    </button>
</div>

<!-- Modal: ConfirmaciÃ³n de Pago (Ya con selecciÃ³n hecha) -->
<div id="modalConfirmar"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-[40px] shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
        <div class="p-8 pb-4">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-black text-gray-800">Finalizar Pago</h3>
                    <p class="text-gray-400 text-sm">Completa los datos de la recaudaciÃ³n</p>
                </div>
                <button onclick="cerrarModalConfirmar()" class="text-gray-300 hover:text-gray-500 transition-colors">
                    <i class="fas fa-times-circle text-2xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Resumen -->
                <div class="bg-gray-50 rounded-3xl p-6 border border-gray-100 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Monto Total</p>
                        <p id="modalTotal" class="text-4xl font-black text-pink-600">$0.00</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">NiÃ±os</p>
                        <p id="modalCount" class="text-xl font-bold text-gray-700">0</p>
                    </div>
                </div>

                <!-- Desglose de NiÃ±os -->
                <div class="space-y-3">
                    <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2 px-1">Desglose
                        por niÃ±o</label>
                    <div id="listaNinosConfirmar" class="space-y-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Se puebla por JS -->
                    </div>
                </div>

                <!-- Controles -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2 px-1">Â¿QuiÃ©n
                            cobrÃ³?</label>
                        <select id="selectEmpleado"
                            class="w-full px-5 py-4 bg-gray-50 border-0 rounded-2xl focus:ring-2 focus:ring-pink-500 focus:outline-none font-bold text-gray-700">
                            {% for emp in employees_activos %}
                            <option value="{{ emp.id }}">{{ emp.nombre }}</option>
                            {% endfor %}
                            <option value="9">Caja / Casa</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2 px-1">MÃ©todo</label>
                            <select id="selectMetodo"
                                class="w-full px-5 py-4 bg-gray-50 border-0 rounded-2xl focus:ring-2 focus:ring-pink-500 focus:outline-none font-bold text-gray-700">
                                <option value="Efectivo">Efectivo ðŸ’µ</option>
                                <option value="Zelle">Zelle ðŸ“±</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-black text-gray-400 uppercase tracking-widest mb-2 px-1">Fecha</label>
                            <input type="date" id="selectFecha" value="{{ get_current_time().strftime('%Y-%m-%d') }}"
                                class="w-full px-5 py-4 bg-gray-50 border-0 rounded-2xl focus:ring-2 focus:ring-pink-500 focus:outline-none font-bold text-gray-700">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-8">
            <button onclick="finalizarRegistro()"
                class="w-full bg-pink-600 hover:bg-pink-700 text-white font-black py-5 rounded-3xl shadow-lg transition-all transform active:scale-95 shadow-pink-200">
                CONFIRMAR Y GUARDAR
            </button>
        </div>
    </div>
</div>

<!-- Modal: Detalles del Grupo -->
<div id="modalDetalles"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 text-center">
    <div
        class="bg-white rounded-[40px] shadow-2xl w-full max-w-md overflow-hidden inline-block text-left align-middle transition-all transform">
        <div class="p-8 bg-gray-50/50 border-b border-gray-100 flex justify-between items-center">
            <div>
                <h3 class="text-xl font-bold text-gray-800">RecaudaciÃ³n</h3>
                <p id="detallesSub" class="text-xs text-gray-400 font-bold uppercase"></p>
            </div>
            <button onclick="cerrarModalDetalles()" class="text-gray-300 hover:text-gray-500">
                <i class="fas fa-times-circle text-2xl"></i>
            </button>
        </div>
        <div class="p-8">
            <ul id="listaDetalles" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                <!-- Se inyecta por JS -->
            </ul>
            <div class="mt-8 pt-6 border-t border-gray-100 flex justify-between items-center">
                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Total Grupo</span>
                <span id="detallesTotal" class="text-3xl font-black text-gray-800"></span>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Ajuste de Saldos -->
<div id="modalAjuste" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-[40px] shadow-xl w-full max-w-lg p-8">
        <h3 class="text-2xl font-black text-gray-800 mb-2">Ajuste de Saldos</h3>
        <p class="text-sm text-gray-400 mb-6 font-medium">Borra la deuda de los niÃ±os seleccionados HASTA la fecha
            indicada.</p>

        <div class="flex justify-between items-center mb-4 px-2">
            <span class="text-xs font-bold text-gray-400 uppercase">NiÃ±os con Deuda</span>
            <button onclick="toggleSelectAllAjuste()"
                class="text-xs font-bold text-pink-600 hover:text-pink-700">Seleccionar Todos</button>
        </div>

        <div class="max-h-60 overflow-y-auto border-2 border-gray-50 rounded-3xl mb-6 p-4 space-y-2 bg-gray-50/30">
            {% for item in pending_payments %}
            <label
                class="flex items-center p-3 hover:bg-white hover:shadow-sm rounded-2xl cursor-pointer transition-all border border-transparent hover:border-gray-100">
                <input type="checkbox" name="ajuste_nino" value="{{ item.id_nino }}"
                    class="form-checkbox text-pink-600 h-5 w-5 mr-4 rounded-lg">
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-gray-700">{{ item.nombre }}</span>
                    <span class="text-[10px] font-black text-pink-400 uppercase">${{ item.saldo_pendiente }}</span>
                </div>
            </label>
            {% endfor %}
        </div>

        <input type="date" id="fechaAjuste" value="{{ get_current_time().strftime('%Y-%m-%d') }}"
            class="w-full p-4 bg-gray-50 border-0 rounded-2xl mb-6 font-bold text-gray-700 focus:ring-2 focus:ring-pink-500 focus:outline-none">

        <div class="flex gap-4">
            <button onclick="cerrarModalAjuste()"
                class="flex-1 py-4 font-black text-gray-400 hover:text-gray-600 transition-colors">CANCELAR</button>
            <button onclick="procesarAjuste()"
                class="flex-1 bg-gray-800 text-white py-4 rounded-2xl font-black shadow-lg shadow-gray-200 hover:bg-black transition-all">CORRER
                AJUSTE</button>
        </div>
    </div>
</div>

<!-- Modal: Ã‰xito (ConfirmaciÃ³n Visual) -->
<div id="modalExito"
    class="fixed inset-0 bg-black/60 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white rounded-[40px] shadow-2xl w-full max-w-sm overflow-hidden p-10 text-center animate-bounce-in">
        <div class="w-24 h-24 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-check text-4xl"></i>
        </div>
        <h3 class="text-3xl font-black text-gray-800 mb-2">Â¡Ã‰xito!</h3>
        <p class="text-gray-400 font-medium mb-8">El pago ha sido registrado correctamente y los saldos actualizados.
        </p>
        <button onclick="location.reload()"
            class="w-full bg-gray-800 hover:bg-black text-white font-black py-4 rounded-2xl shadow-lg transition-all transform active:scale-95">
            ENTENDIDO
        </button>
    </div>
</div>

<!-- Modal: ConfirmaciÃ³n de AcciÃ³n (Reemplazo de confirm) -->
<div id="modalConfirmacionAccion"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-[40px] shadow-2xl w-full max-w-sm overflow-hidden p-8 text-center animate-bounce-in">
        <div class="w-20 h-20 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-exclamation-triangle text-3xl"></i>
        </div>
        <h3 id="confirmTitulo" class="text-2xl font-black text-gray-800 mb-2">Â¿EstÃ¡s seguro?</h3>
        <p id="confirmTexto" class="text-gray-400 font-medium mb-8 px-2"></p>
        <div class="flex gap-4">
            <button onclick="cerrarConfirmacion()"
                class="flex-1 py-4 font-black text-gray-400 hover:text-gray-600 transition-colors">CANCELAR</button>
            <button id="btnConfirmarAccion"
                class="flex-1 bg-red-500 hover:bg-red-600 text-white py-4 rounded-2xl font-black shadow-lg transition-all transform active:scale-95">REVERTIR</button>
        </div>
    </div>
</div>

<script>
    let seleccionados = [];

    function toggleNinoSelection(element, id, nombre, monto) {
        const index = seleccionados.findIndex(s => s.id === id);
        if (index > -1) {
            seleccionados.splice(index, 1);
            element.classList.remove('ring-4', 'ring-pink-500', 'border-pink-500', 'bg-pink-50', 'scale-95');
            element.querySelector('.check-mark').classList.add('opacity-0');
            element.querySelector('.check-mark').classList.add('scale-50');
        } else {
            seleccionados.push({ id, nombre, monto });
            element.classList.add('ring-4', 'ring-pink-500', 'border-pink-500', 'bg-pink-50', 'scale-95');
            element.querySelector('.check-mark').classList.remove('opacity-0');
            element.querySelector('.check-mark').classList.remove('scale-50');
        }

        actualizarVistaBotones();
    }

    function actualizarVistaBotones() {
        const container = document.getElementById('floatingBtnContainer');
        const total = seleccionados.reduce((sum, s) => sum + s.monto, 0);

        if (seleccionados.length > 0) {
            container.classList.remove('hidden');
            document.getElementById('countBadge').innerText = seleccionados.length;
            document.getElementById('totalBadge').innerText = `$${total.toFixed(2)}`;
        } else {
            container.classList.add('hidden');
        }
    }

    function abrirModalConfirmacion() {
        const total = seleccionados.reduce((sum, s) => sum + s.monto, 0);
        document.getElementById('modalTotal').innerText = `$${total.toFixed(2)}`;
        document.getElementById('modalCount').innerText = seleccionados.length;

        // Poblar lista de niÃ±os con inputs
        let html = '';
        seleccionados.forEach(s => {
            html += `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-2xl border border-gray-100">
                <span class="text-sm font-bold text-gray-700 truncate mr-2">${s.nombre}</span>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">$</span>
                    <input type="number" step="0.01" value="${s.monto.toFixed(2)}" 
                        onchange="validarMontoItem(this, ${s.monto}, '${s.id}')"
                        class="w-20 bg-white border-0 rounded-lg py-1 px-2 text-right font-black text-pink-600 focus:ring-2 focus:ring-pink-500 text-sm"
                        data-nino-id="${s.id}">
                </div>
            </div>`;
        });
        document.getElementById('listaNinosConfirmar').innerHTML = html;

        document.getElementById('modalConfirmar').classList.remove('hidden');
    }

    function validarMontoItem(input, max, id_nino) {
        let valor = parseFloat(input.value);
        if (isNaN(valor)) valor = 0;

        if (valor > max) {
            alert(`No puedes cobrar mÃ¡s de la deuda actual ($${max.toFixed(2)})`);
            valor = max;
        } else if (valor < 0) {
            valor = 0;
        }

        input.value = valor.toFixed(2);

        // Actualizar el array local de seleccionados para que finalizarRegistro use los valores correctos
        const index = seleccionados.findIndex(s => s.id === id_nino);
        if (index > -1) {
            seleccionados[index].monto_editado = valor;
        }

        // Recalcular total del modal
        const inputs = document.querySelectorAll('#listaNinosConfirmar input');
        let nuevoTotal = 0;
        inputs.forEach(inp => nuevoTotal += parseFloat(inp.value));
        document.getElementById('modalTotal').innerText = `$${nuevoTotal.toFixed(2)}`;
    }

    function cerrarModalConfirmar() {
        document.getElementById('modalConfirmar').classList.add('hidden');
    }

    function finalizarRegistro() {
        const id_empleado = document.getElementById('selectEmpleado').value;
        const metodo = document.getElementById('selectMetodo').value;
        const fecha = document.getElementById('selectFecha').value;

        // Mapear seleccionados al formato que espera /api/pagos/registrar_pago_multiple
        const pagos = seleccionados.map(s => ({
            id_nino: s.id,
            monto: s.monto_editado !== undefined ? s.monto_editado : s.monto,
            id_empleado: id_empleado,
            fecha: fecha,
            tipo: metodo
        }));

        // Bloquear botÃ³n para evitar doble click
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> GUARDANDO...';

        fetch('/api/pagos/registrar_pago_multiple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pagos: pagos })
        }).then(res => res.json()).then(data => {
            if (data.success) {
                document.getElementById('modalConfirmar').classList.add('hidden');
                document.getElementById('modalExito').classList.remove('hidden');
            } else {
                alert('Error: ' + data.error);
                btn.disabled = false;
                btn.innerText = 'CONFIRMAR Y GUARDAR';
            }
        }).catch(err => {
            alert('Error de conexiÃ³n');
            btn.disabled = false;
            btn.innerText = 'CONFIRMAR Y GUARDAR';
        });
    }

    function filtrarNinos() {
        const input = document.getElementById('filtroNino').value.toLowerCase();
        document.querySelectorAll('.nino-card').forEach(card => {
            const nombre = card.getAttribute('data-nombre').toLowerCase();
            card.style.display = nombre.includes(input) ? '' : 'none';
        });
    }

    function seleccionarTodosToggle() {
        const cards = document.querySelectorAll('.nino-card:not([style*="display: none"])');
        // Si la cantidad de seleccionados es igual a la cantidad de visibles, deseleccionamos todos
        // de lo contrario, seleccionamos los que falten de los visibles.
        const visiblesIds = Array.from(cards).map(c => c.getAttribute('onclick').match(/'([^']+)'/)[1]);
        const todosVisiblesSeleccionados = visiblesIds.every(id => seleccionados.some(s => s.id === id));

        if (todosVisiblesSeleccionados) {
            // Deseleccionar los visibles
            cards.forEach(c => {
                const id = c.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (seleccionados.some(s => s.id === id)) c.click();
            });
        } else {
            // Seleccionar los visibles que no estÃ¡n seleccionados
            cards.forEach(c => {
                const id = c.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (!seleccionados.some(s => s.id === id)) c.click();
            });
        }
    }

    async function verDetallesGrupo(fecha, id_emp, nombre_emp, total) {
        document.getElementById('detallesSub').innerText = `${fecha} â€¢ ${nombre_emp}`;
        document.getElementById('detallesTotal').innerText = `$${parseFloat(total).toFixed(2)}`;
        document.getElementById('listaDetalles').innerHTML = '<li class="text-center text-gray-300 py-8"><i class="fas fa-circle-notch fa-spin text-2xl"></i></li>';
        document.getElementById('modalDetalles').classList.remove('hidden');

        // LÃ³gica de fecha para revertir (Solo hoy o futuro)
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const fechaPago = new Date(fecha + 'T00:00:00');
        const esRevertible = fechaPago >= hoy;

        try {
            const res = await fetch(`/api/pagos/detalles?fecha=${fecha}&id_empleada=${id_emp}`);
            const data = await res.json();

            let html = '';
            data.forEach(p => {
                const icon = p.tipo === 'Zelle' ? 'ðŸ“±' : 'ðŸ’µ';
                const btnRevertir = esRevertible ?
                    `<button onclick="revertirPago(${p.id})" class="text-red-400 hover:text-red-600 p-2 transition-colors" title="Revertir Pago">
                        <i class="fas fa-undo-alt"></i>
                    </button>` : '';

                html += `
                <li class="flex justify-between items-center p-4 bg-gray-50 rounded-2-xl border border-gray-100/50">
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-800 text-sm">${p.nombre_nino}</span>
                        <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest">${p.tipo} ${icon}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-gray-700">$${p.monto.toFixed(2)}</span>
                        ${btnRevertir}
                    </div>
                </li>`;
            });
            document.getElementById('listaDetalles').innerHTML = html || '<li class="text-center text-gray-400">Sin datos</li>';
        } catch (e) {
            document.getElementById('listaDetalles').innerHTML = '<li class="text-red-400 text-center font-bold">Error de conexiÃ³n</li>';
        }
    }

    function customConfirm(titulo, texto, accion) {
        document.getElementById('confirmTitulo').innerText = titulo;
        document.getElementById('confirmTexto').innerText = texto;
        const btn = document.getElementById('btnConfirmarAccion');

        // Clonar botÃ³n para limpiar event listeners previos
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.onclick = () => {
            cerrarConfirmacion();
            accion();
        };

        document.getElementById('modalConfirmacionAccion').classList.remove('hidden');
    }

    function cerrarConfirmacion() {
        document.getElementById('modalConfirmacionAccion').classList.add('hidden');
    }

    function revertirPago(id) {
        customConfirm(
            'Â¿Revertir Pago?',
            'Â¿EstÃ¡s seguro de que quieres revertir este pago? El saldo del niÃ±o se ajustarÃ¡ automÃ¡ticamente.',
            () => {
                // Bloquear UI momentÃ¡neamente
                document.getElementById('listaDetalles').innerHTML = '<li class="text-center py-8"><i class="fas fa-circle-notch fa-spin text-2xl"></i></li>';

                fetch(`/api/pagos/revertir/${id}`, { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                            location.reload();
                        }
                    })
                    .catch(err => {
                        alert('Error de conexiÃ³n');
                        location.reload();
                    });
            }
        );
    }

    function revertirGrupo(pago_ids) {
        customConfirm(
            'Â¿Revertir Grupo?',
            `Â¿EstÃ¡s seguro de revertir este grupo de ${pago_ids.length} pagos? Se ajustarÃ¡n los saldos de todos los niÃ±os involucrados.`,
            () => {
                // Mostrar cargando
                document.body.style.cursor = 'wait';

                fetch('/api/pagos/revertir_grupo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pago_ids })
                })
                    .then(res => res.json())
                    .then(data => {
                        document.body.style.cursor = 'default';
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(err => {
                        document.body.style.cursor = 'default';
                        alert('Error de conexiÃ³n');
                    });
            }
        );
    }

    function cerrarModalDetalles() { document.getElementById('modalDetalles').classList.add('hidden'); }
    function abrirModalAjuste() { document.getElementById('modalAjuste').classList.remove('hidden'); }
    function cerrarModalAjuste() { document.getElementById('modalAjuste').classList.add('hidden'); }

    function procesarAjuste() {
        const ninos_ids = Array.from(document.querySelectorAll('input[name="ajuste_nino"]:checked')).map(cb => cb.value);
        const fecha = document.getElementById('fechaAjuste').value;
        if (ninos_ids.length === 0) { alert('Selecciona algÃºn niÃ±o'); return; }

        fetch('/api/gastos/ajustar_pagos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ninos_ids, fecha })
        }).then(res => res.json()).then(data => {
            if (data.success) { alert('Ajuste exitoso'); location.reload(); }
            else { alert('Error: ' + data.error); }
        });
    }

    function toggleSelectAllAjuste() {
        const checkboxes = document.querySelectorAll('input[name="ajuste_nino"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }
</script>

<style>
    @keyframes bounce-subtle {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-5px);
        }
    }

    .animate-bounce-subtle {
        animation: bounce-subtle 3s infinite ease-in-out;
    }

    @keyframes slide-up {
        from {
            transform: translateY(100%);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .animate-slide-up {
        animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes bounce-in {
        0% {
            transform: scale(0.5);
            opacity: 0;
        }

        70% {
            transform: scale(1.05);
            opacity: 1;
        }

        100% {
            transform: scale(1);
        }
    }

    .animate-bounce-in {
        animation: bounce-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .nino-card {
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .nino-card:hover {
        transform: translateY(-3px);
    }

    .nino-card:active {
        transform: scale(0.95);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #fee2e2;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #fecaca;
    }
</style>
{% endblock %}