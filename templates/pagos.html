{% extends "layouts/base.html" %}

{% block title %}Pagos - Guardería{% endblock %}

{% block header_title %}Gestión de Pagos{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Card: Pagos Pendientes -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-red-100">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-red-700">
                <i class="fas fa-file-invoice-dollar mr-3"></i>
                Pagos pendientes
            </h2>
            <button onclick="showAddPagoModal()" class="bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md">
                <i class="fas fa-plus mr-2"></i>
                Registrar Pago
            </button>
        </div>
        
        {% if pending_payments %}
            <div class="overflow-y-auto max-h-[60vh]">
                <table class="w-full text-left">
                    <thead class="bg-red-50 border-b border-red-200 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 font-semibold text-red-700">Niño</th>
                            <th class="px-4 py-3 font-semibold text-red-700 text-right">Deuda Total</th>
                            <th class="px-4 py-3 font-semibold text-red-700 text-right">Total Pagado</th>
                            <th class="px-4 py-3 font-semibold text-red-700 text-right">Saldo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in pending_payments %}
                        <tr class="border-b border-red-100 hover:bg-red-50 transition-colors duration-200">
                            <td class="px-4 py-4 font-medium text-red-800">{{ pago.nombre }}</td>
                            <td class="px-4 py-4 text-red-700 text-right">$ {{ "%.2f"|format(pago.total_deuda) }}</td>
                            <td class="px-4 py-4 text-green-700 text-right">$ {{ "%.2f"|format(pago.total_pagado) }}</td>
                            <td class="px-4 py-4 font-bold text-right {% if pago.saldo_pendiente > 0 %}text-red-600{% elif pago.saldo_pendiente < 0 %}text-green-600{% else %}text-gray-600{% endif %}">
                                $ {{ "%.2f"|format(pago.saldo_pendiente) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-8">
                <i class="fas fa-check-circle text-green-400 text-4xl mb-4"></i>
                <p class="text-gray-500 text-lg">No hay pagos pendientes.</p>
            </div>
        {% endif %}
    </div>

    <!-- Card: Últimos Pagos Registrados -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-blue-100">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-blue-700">
                <i class="fas fa-history mr-3"></i>
                Últimos Pagos
            </h2>
        </div>
        
        {% if recent_pagos %}
            <div class="overflow-y-auto max-h-[60vh]">
                <table class="w-full text-left">
                    <thead class="bg-blue-50 border-b border-blue-200 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 font-semibold text-blue-700">Fecha</th>
                            <th class="px-4 py-3 font-semibold text-blue-700">Niño</th>
                            <th class="px-4 py-3 font-semibold text-blue-700">Empleada</th>
                            <th class="px-4 py-3 font-semibold text-blue-700">Tipo</th>
                            <th class="px-4 py-3 font-semibold text-blue-700 text-right">Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in recent_pagos %}
                        <tr class="border-b border-blue-100 hover:bg-blue-50 transition-colors duration-200">
                            <td class="px-4 py-4 text-blue-800">{{ pago.date }}</td>
                            <td class="px-4 py-4 font-medium text-blue-800">{{ pago.nombre_nino }}</td>
                            <td class="px-4 py-4 font-medium text-blue-800">{{ pago.nombre_empleada }}</td>
                            <td class="px-4 py-4 text-blue-800">{{ pago.tipo }}</td>
                            <td class="px-4 py-4 text-blue-700 text-right">$ {{ "%.2f"|format(pago.monto) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-8">
                <i class="fas fa-receipt text-blue-300 text-4xl mb-4"></i>
                <p class="text-blue-500 text-lg">No se han registrado pagos recientemente.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal para agregar pago -->
<div id="addPagoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300">
        <div class="text-center">
            <h2 class="text-2xl font-bold text-pink-700 mb-6">Registrar Pago</h2>
        </div>
        <form id="addPagoForm">
            <div class="space-y-4 text-left">
                
                <div>
                    <label for="pagoNino" class="block text-sm font-medium text-gray-700 mb-2">Niño que paga:</label>
                    <select id="pagoNino" name="id_nino" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <option value="">Seleccione un niño</option>
                        {% for nino in ninos_activos %}
                            <option value="{{ nino.id }}">{{ nino.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="pagoEmpleado" class="block text-sm font-medium text-gray-700 mb-2">Empleada que recibe:</label>
                    <select id="pagoEmpleado" name="id_empleado" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <option value="">Seleccione una empleada</option>
                        {% for emp in employees_activos %}
                            <option value="{{ emp.id }}">{{ emp.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="pagoTipo" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pago:</label>
                    <select id="pagoTipo" name="tipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Zelle">Zelle</option>
                    </select>
                </div>
                
                <div>
                    <label for="pagoFecha" class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
                    <input type="date" id="pagoFecha" name="fecha" value="{{ get_current_time().date().isoformat() }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                </div>
                
                <div>
                    <label for="pagoMonto" class="block text-sm font-medium text-gray-700 mb-2">Monto:</label>
                    <input type="number" id="pagoMonto" name="monto" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="0.00">
                </div>
            </div>
            
            <div class="flex space-x-4 mt-6">
                <button type="submit" class="flex-1 bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300">
                    Guardar Pago
                </button>
                <button type="button" onclick="closeAddPagoModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-300">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const addPagoModal = document.getElementById('addPagoModal');
    const addPagoForm = document.getElementById('addPagoForm');

    function showAddPagoModal() {
        addPagoModal.classList.remove('hidden');
        addPagoModal.classList.add('flex');
    }

    function closeAddPagoModal() {
        addPagoModal.classList.add('hidden');
        addPagoModal.classList.remove('flex');
        addPagoForm.reset();
    }

    addPagoModal.addEventListener('click', (e) => {
        if (e.target === addPagoModal) {
            closeAddPagoModal();
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !addPagoModal.classList.contains('hidden')) {
            closeAddPagoModal();
        }
    });

    addPagoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(addPagoForm);
        
        const data = {
            id_nino: parseInt(formData.get('id_nino')),
            id_empleado: parseInt(formData.get('id_empleado')),
            fecha: formData.get('fecha'),
            monto: parseFloat(formData.get('monto')),
            tipo: formData.get('tipo')
        };

        if (!data.id_nino || !data.id_empleado || !data.fecha || isNaN(data.monto) || !data.tipo) {
            alert('Por favor, complete todos los campos correctamente.');
            return;
        }

        try {
            const response = await fetch('/api/pagos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                alert('Pago registrado exitosamente.');
                window.location.reload();
            } else {
                alert('Error al registrar el pago: ' + result.error);
            }
        } catch (error) {
            console.error('Error al registrar pago:', error);
            alert('Ocurrió un error al registrar el pago.');
        }
    });
</script>
{% endblock %}