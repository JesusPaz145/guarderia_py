{% extends "layouts/base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Encabezado y Paginación -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Gastos de la Semana</h1>
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('gastos', date=prev_week_start_str) }}" class="bg-pink-100 hover:bg-pink-200 text-pink-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                &larr; Semana Anterior
            </a>
            <div class="text-center">
                <p class="text-xl font-semibold text-gray-700">{{ week_start_str }} - {{ week_end_str }}</p>
                <p class="text-sm text-gray-500">Semana Actual</p>
            </div>
            <a href="{{ url_for('gastos', date=next_week_start_str) }}" class="bg-pink-100 hover:bg-pink-200 text-pink-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                Semana Siguiente &rarr;
            </a>
        </div>
    </div>

    <!-- Resumen de Gastos y Botón para Agregar -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-8 flex justify-between items-center">
        <div>
            <h2 class="text-xl font-semibold text-gray-700">Total de Gastos de la Semana</h2>
            <p class="text-4xl font-bold text-pink-600">${{ "%.2f"|format(total_gastos) }}</p>
        </div>
        {% if session.get('user_level') == 'Admin' %}
        <button onclick="abrirModalNuevo()" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
            + Agregar Gasto
        </button>
        {% endif %}
    </div>
    
    <!-- Tabla de Gastos -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-pink-50">
                    <tr>
                        <th class="px-4 sm:px-6 py-4 text-left text-sm font-semibold text-pink-800">Fecha</th>
                        <th class="px-4 sm:px-6 py-4 text-left text-sm font-semibold text-pink-800">Motivo</th>
                        <th class="px-4 sm:px-6 py-4 text-left text-sm font-semibold text-pink-800">Monto</th>
                        <th class="px-4 sm:px-6 py-4 text-center text-sm font-semibold text-pink-800">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for gasto in gastos %}
                    <tr class="border-t hover:bg-pink-50/50 transition-colors" data-id="{{ gasto.id }}" data-fecha="{{ gasto.fecha }}">
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">{{ gasto.fecha }}</td>
                        <td class="px-4 sm:px-6 py-4">{{ gasto.motivo }}</td>
                        <td class="px-4 sm:px-6 py-4">${{ "%.2f"|format(gasto.monto) }}</td>
                        <td class="px-4 sm:px-6 py-4 flex justify-center gap-2 flex-wrap">
                            {% if session.get('user_level') == 'Admin' %}
                            <button onclick="editarGasto('{{ gasto.id }}')" 
                                    class="bg-pink-500 text-white px-3 py-1 rounded-lg hover:bg-pink-600 transition duration-300 text-sm">
                                <span class="hidden sm:inline">Editar</span>
                                <i class="fas fa-edit sm:hidden"></i>
                            </button>
                            <button onclick="eliminarGasto('{{ gasto.id }}')" 
                                    class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition duration-300 text-sm">
                                <span class="hidden sm:inline">Eliminar</span>
                                <i class="fas fa-trash sm:hidden"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal para Agregar/Editar Gasto -->
<div id="gastoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900 mb-4">Agregar Nuevo Gasto</h3>
            <form id="gastoForm" class="space-y-4">
                <input type="hidden" id="gastoId" name="gastoId">
                
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" name="fecha" id="fecha" 
                           class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                </div>
                
                <div>
                    <label for="motivo" class="block text-sm font-medium text-gray-700">Motivo</label>
                    <input type="text" name="motivo" id="motivo" 
                           class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                </div>
                
                <div>
                    <label for="monto" class="block text-sm font-medium text-gray-700">Monto</label>
                    <input type="number" step="0.01" name="monto" id="monto" 
                           class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                </div>

                <div class="mt-6 flex flex-col space-y-2">
                    <button type="submit" 
                            class="w-full px-4 py-2 bg-pink-500 text-white font-semibold rounded-lg hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-opacity-50 transition duration-300">
                        Guardar Gasto
                    </button>
                    <button type="button" onclick="cerrarModal()" 
                            class="w-full px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition duration-300">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const modal = document.getElementById('gastoModal');
const form = document.getElementById('gastoForm');

function abrirModalNuevo() {
    document.getElementById('modalTitle').textContent = 'Agregar Nuevo Gasto';
    document.getElementById('gastoId').value = '';
    document.getElementById('fecha').valueAsDate = new Date();
    document.getElementById('motivo').value = '';
    document.getElementById('monto').value = '';
    abrirModal();
}

function editarGasto(id) {
    console.log('Editando gasto:', id);
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) {
        console.error('No se encontró la fila para el gasto:', id);
        return;
    }
    document.getElementById('modalTitle').textContent = 'Editar Gasto';
    document.getElementById('gastoId').value = id;
    document.getElementById('fecha').value = row.getAttribute('data-fecha');
    document.getElementById('motivo').value = row.children[1].textContent.trim();
    document.getElementById('monto').value = row.children[2].textContent.replace('$', '').trim();
    abrirModal();
}

function abrirModal() {
    modal.classList.remove('hidden');
}

function cerrarModal() {
    modal.classList.add('hidden');
}

function eliminarGasto(id) {
    if (confirm('¿Estás seguro de eliminar este gasto?')) {
        fetch('/api/gastos/' + id, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al eliminar el gasto');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar el gasto');
        });
    }
}

form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const id = document.getElementById('gastoId').value;
    const data = {
        fecha: document.getElementById('fecha').value,
        motivo: document.getElementById('motivo').value,
        monto: parseFloat(document.getElementById('monto').value)
    };

    try {
        const response = await fetch(id ? `/api/gastos/${id}` : '/api/gastos', {
            method: id ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert('Error al guardar el gasto: ' + (result.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar el gasto');
    }
});

// Cerrar modal al hacer clic fuera
modal.addEventListener('click', function(e) {
    if (e.target === modal) {
        cerrarModal();
    }
});
</script>
{% endblock %}